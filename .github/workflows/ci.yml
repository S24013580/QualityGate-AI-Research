name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  repository_dispatch:
    types: [tests-generated]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download generated tests from Python project
      if: github.event_name == 'repository_dispatch' || github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        REPO_OWNER="S24013580"
        REPO_NAME="QualityGate-AI"
        ARTIFACT_NAME="generated-java-tests"
        
        # Determine which workflow run to use
        if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
          # Use the workflow run ID from the dispatch payload
          RUN_ID="${{ github.event.client_payload.workflow_run_id }}"
          if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
            echo "Using workflow_run ID from dispatch: $RUN_ID"
          else
            RUN_ID=""
          fi
        fi
        
        # If no RUN_ID from dispatch, find the latest successful workflow run
        if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
          echo "Fetching latest workflow run from $REPO_OWNER/$REPO_NAME..."
          RUN_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/runs?per_page=5&status=success" \
            | jq -r '.workflow_runs[] | select(.name == "CI") | .id' | head -1)
        fi
        
        if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
          echo "No workflow run found. Skipping test download."
          exit 0
        fi
        
        echo "Using workflow run ID: $RUN_ID"
        
        # Get the artifact ID
        ARTIFACT_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/runs/$RUN_ID/artifacts" \
          | jq -r ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id")
        
        if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
          echo "Artifact '$ARTIFACT_NAME' not found in run $RUN_ID. Skipping test download."
          exit 0
        fi
        
        echo "Found artifact ID: $ARTIFACT_ID"
        
        # Create directory for tests
        mkdir -p src/test/java
        
        # Download and extract the artifact
        curl -L -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          -o /tmp/tests.zip \
          "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/artifacts/$ARTIFACT_ID/zip"
        
        if [ -f /tmp/tests.zip ]; then
          echo "Extracting tests to src/test/java..."
          unzip -q /tmp/tests.zip -d /tmp/tests || true
          # Copy tests preserving package structure
          if [ -d "/tmp/tests/com" ]; then
            cp -r /tmp/tests/com src/test/java/ 2>/dev/null || true
            echo "Tests extracted to src/test/java/com/"
          elif [ -d "/tmp/tests" ]; then
            # Try to find Java files and copy with structure
            find /tmp/tests -name "*.java" -type f | while read file; do
              rel_path=${file#/tmp/tests/}
              target_dir="src/test/java/$(dirname "$rel_path")"
              mkdir -p "$target_dir"
              cp "$file" "$target_dir/"
            done
            echo "Tests extracted to src/test/java/"
          fi
          echo "✅ Tests downloaded successfully"
          find src/test/java -name "*Test.java" | wc -l | xargs echo "Found test files:"
        else
          echo "⚠️ Failed to download artifact. Continuing without generated tests."
        fi
      continue-on-error: true
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Compile
      run: mvn clean compile
    
    - name: Check for existing tests
      id: check-tests
      run: |
        if [ -d "src/test/java" ] && [ "$(find src/test/java -name '*Test.java' | wc -l)" -gt 0 ]; then
          echo "tests_exist=true" >> $GITHUB_OUTPUT
        else
          echo "tests_exist=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Run tests with coverage
      run: mvn clean test jacoco:report
    
    - name: Enforce coverage thresholds
      run: mvn verify
      continue-on-error: false
      env:
        MAVEN_OPTS: -Xmx2048m
    
    - name: Report coverage status
      if: always()
      run: |
        echo "## Coverage Status" >> $GITHUB_STEP_SUMMARY
        COVERAGE_OUTPUT=$(mvn verify -q 2>&1 || true)
        if echo "$COVERAGE_OUTPUT" | grep -q "Coverage checks have not been met"; then
          echo "⚠️ Coverage thresholds not fully met. Current status:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Details" >> $GITHUB_STEP_SUMMARY
          echo "$COVERAGE_OUTPUT" | grep -E "(Rule violated|Warning:)" | head -20 >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Tests are running successfully. Coverage will improve as tests are regenerated with enhanced prompts." >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ Coverage thresholds met!" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: target/site/jacoco/
      if: always()
    
    - name: Run mutation testing
      run: mvn org.pitest:pitest-maven:mutationCoverage || echo "Mutation testing completed with warnings"
      continue-on-error: true
    
    - name: Upload mutation reports
      uses: actions/upload-artifact@v4
      with:
        name: mutation-reports
        path: target/pit-reports/
      if: always()
    
    - name: Build JAR
      run: mvn clean package -DskipTests
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: application-jar
        path: target/*.jar
        retention-days: 30
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: application-jar
        path: target/
    
    - name: Configure Maven for GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml <<EOF
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
          http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>github</id>
              <username>${{ github.actor }}</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
        </settings>
        EOF
    
    - name: Publish to GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mvn deploy -DskipTests
      continue-on-error: false
    
    - name: Set up Docker Buildx
      if: env.DOCKER_HUB_USERNAME != ''
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      if: env.DOCKER_HUB_USERNAME != ''
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: |
          ${{ secrets.DOCKER_HUB_USERNAME }}/qualitygate-research:${{ github.sha }}
          ${{ secrets.DOCKER_HUB_USERNAME }}/qualitygate-research:latest
        cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/qualitygate-research:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/qualitygate-research:buildcache,mode=max
      env:
        DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
    
    - name: Login to Docker Hub
      if: env.DOCKER_HUB_USERNAME != ''
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}
    
    - name: Push Docker image
      if: env.DOCKER_HUB_USERNAME != ''
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_HUB_USERNAME }}/qualitygate-research:${{ github.sha }}
          ${{ secrets.DOCKER_HUB_USERNAME }}/qualitygate-research:latest
      env:
        DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
